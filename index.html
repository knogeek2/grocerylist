<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocery List</title>
    <style>
        body {
            font-family: Segoe UI,Arial,sans-serif;
            margin: 0;
            background: #f8fafc;
            color: #1e293b;
        }

        .tabs {
            display: flex;
            background: #1e40af;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tab {
            padding: 18px 36px;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

            .tab.active {
                background: #1e3a8a;
                border-bottom: 6px solid #60a5fa;
            }

        .content {
            padding: 34px;
            max-width: 1580px;
            margin: auto;
            display: none;
        }

            .content.active {
                display: block;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 6px 24px rgba(0,0,0,0.13);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
        }

        th {
            background: #1e40af;
            color: white;
            padding: 16px;
            text-align: left;
        }

        td {
            padding: 14px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f1f5f9;
        }

        .add {
            background: #166534;
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 6px;
            cursor: pointer;
        }

            .add:hover {
                background: #1f7a40;
            }

        .total {
            font-size: 2.4em;
            font-weight: bold;
            text-align: right;
            margin: 40px 0;
            color: #1e40af;
        }

        #search {
            width: 100%;
            padding: 18px;
            font-size: 19px;
            border: 1px solid #94a3b8;
            border-radius: 10px;
            box-sizing: border-box;
        }

        .out {
            color: #dc2626;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="tabs">
        <div class="tab active" onclick="openTab('all')">All Prices</div>
        <div class="tab" onclick="openTab('favorites')">Favorites</div>
        <div class="tab" onclick="openTab('reorder')">Need to Reorder</div>
    </div>

    <div id="all" class="content active">
        <h1>All Prices</h1>
        <input type="text" id="search" placeholder="Search..." autofocus>
        <table id="allTable">
            <thead>
                <tr>
                    <th>Vendor</th>
                    <th>Item</th>
                    <th>Shelf</th>
                    <th>SKU</th>
                    <th>REORDERNE</th>
                    <th>Price</th>
                    <th>Qty</th>
                    <th>Unit</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="favorites" class="content">
        <h1>Favorites</h1>
        <table id="favTable">
            <thead>
                <tr>
                    <th>Times</th>
                    <th>Item</th>
                    <th>Vendor</th>
                    <th>Avg Cost</th>
                    <th>Last</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="reorder" class="content">
        <h1>Need to Reorder</h1>
        <p>Shows items where REORDERNE ≤ today, last purchase > 14 days ago, and ≤ 365 days ago.</p>
        <table id="reorderTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Vendor</th>
                    <th>Last Received</th>
                    <th>REORDERNE</th>
                    <th>Days Over</th>
                    <th>Est Cost</th>
                    <th>Qty</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <h2 style="margin:80px 34px 0;">Current Order</h2>
    <div class="total" id="totalCost">Total estimated: $0.00</div>
    <table id="orderTable"><thead><tr><th>Item</th><th>Qty</th><th>Vendor</th><th>Est Total</th><th></th></tr></thead><tbody></tbody></table>

    <script>
        let all = [], order = [];
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const recent = new Date(); recent.setDate(recent.getDate() - 14);
        const stale = new Date(); stale.setDate(stale.getDate() - 365);

        Promise.all([
            fetch('allprices.json?t=' + Date.now()).then(r => r.json()),
            fetch('current-list.json?t=' + Date.now()).then(r => r.ok ? r.json() : []).catch(() => [])
        ]).then(([data, saved]) => {
            all = data; order = saved || [];
            renderAll(); renderFavorites(); renderReorder(); renderOrder();
        });

        function get(row, ...keys) { for (let k of keys) if (row[k] !== undefined) return row[k]; return ''; }

        function avgCost(item, vendor) {
            const m = all.filter(r => get(r, 'ITEM', 'Item') === item && get(r, 'VENDOR', 'Vendor', 'STORE', 'Store') === vendor);
            return m.length ? m.reduce((s, r) => s + parseFloat(get(r, 'PRICE', 'Price') || 0), 0) / m.length : 0;
        }

        function typQty(item, vendor) {
            const m = all.filter(r => get(r, 'ITEM', 'Item') === item && get(r, 'VENDOR', 'Vendor', 'STORE', 'Store') === vendor);
            return m.length ? m.reduce((s, r) => s + parseFloat(get(r, 'QTY', 'Qty') || 1), 0) / m.length : 1;
        }

        function lastDate(item, vendor) {
            const d = all.filter(r => get(r, 'ITEM', 'Item') === item && get(r, 'VENDOR', 'Vendor', 'STORE', 'Store') === vendor)
                .map(r => get(r, 'REORDERNE', 'ReorderDate')).filter(Boolean)
                .map(d => new Date(d)).filter(d => !isNaN(d));
            return d.length ? new Date(Math.max(...d)) : null;
        }

        function renderAll() {
            const term = (document.getElementById('search')?.value || '').toLowerCase();
            const tbody = document.querySelector('#allTable tbody'); tbody.innerHTML = '';
            all.forEach(r => {
                if (term && !JSON.stringify(r).toLowerCase().includes(term)) return;
                const v = get(r, 'VENDOR', 'Vendor', 'STORE', 'Store'), i = get(r, 'ITEM', 'Item');
                const q = parseFloat(get(r, 'QTY', 'Qty')) || 1, p = parseFloat(get(r, 'PRICE', 'Price')) || 0;
                tbody.insertRow().innerHTML = `<td style="font-size:0.94em;max-width:420px;">${v}</td><td><strong>${i}</strong></td><td>${get(r, 'SHELF', 'Shelf')}</td><td>${get(r, 'SKU', 'Sku')}</td><td>${get(r, 'REORDERNE')}</td><td>$${p.toFixed(2)}</td><td>${q}</td><td>$${(p / q).toFixed(4)}</td><td><button class="add" onclick="add('${esc(i)}','${esc(v)}',${typQty(i, v)})">Add</button></td>`;
            });
        }

        function renderFavorites() {
            const c = {}; all.forEach(r => { const k = `${get(r, 'ITEM', 'Item')}¶${get(r, 'VENDOR', 'Vendor', 'STORE', 'Store')}`; c[k] = (c[k] || 0) + 1; });
            const s = Object.entries(c).map(([k, n]) => ({ k, n, item: k.split('¶')[0], vendor: k.split('¶')[1] })).sort((a, b) => b.n - a.n);
            const tbody = document.querySelector('#favTable tbody'); tbody.innerHTML = '';
            s.forEach(o => { const last = lastDate(o.item, o.vendor); tbody.insertRow().innerHTML = `<td>${o.n}</td><td><strong>${o.item}</strong></td><td style="font-size:0.94em;">${o.vendor}</td><td>$${avgCost(o.item, o.vendor).toFixed(2)}</td><td>${last ? last.toISOString().slice(0, 10) : ''}</td><td><button class="add" onclick="add('${esc(o.item)}','${esc(o.vendor)}',${typQty(o.item, o.vendor)})">Add</button></td>`; });
        }

        function renderReorder() {
            const tbody = document.querySelector('#reorderTable tbody'); tbody.innerHTML = ''; const seen = new Set();
            let found = 0;
            all.forEach(r => {
                const i = get(r, 'ITEM', 'Item'), v = get(r, 'VENDOR', 'Vendor', 'STORE', 'Store');
                const key = `${i}¶${v}`; if (seen.has(key)) return; seen.add(key);
                const last = lastDate(i, v); if (!last) return;
                const re = get(r, 'REORDERNE') || '1900-01-01'; const rd = new Date(re); rd.setHours(0, 0, 0, 0);
                if (rd > today || last > recent || last < stale) return;
                found++;
                const days = Math.floor((today - rd) / 86400000);
                const tr = tbody.insertRow();
                tr.innerHTML = `<td><strong>${i}</strong></td><td style="font-size:0.94em;">${v}</td><td>${last.toISOString().slice(0, 10)}</td><td>${re}</td><td class="out">${days === 0 ? 'Today' : days + ' days'}</td><td>$${avgCost(i, v).toFixed(2)}</td><td>${typQty(i, v).toFixed(1)}</td><td><button class="add" onclick="add('${esc(i)}','${esc(v)}',${typQty(i, v)})">Add</button></td>`;
            });
            if (!found) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:80px;color:#166534;">Nothing to reorder right now.</td></tr>';
        }

        function add(item, vendor, q) {
            const qty = prompt(`Quantity for "${item}"?`, q.toFixed(1));
            if (!qty || isNaN(qty) || qty <= 0) return;
            order.push({ item, qty: parseFloat(qty), vendor, estTotal: parseFloat((avgCost(item, vendor) * qty).toFixed(2)) });
            save(); renderOrder();
        }

        function save() { fetch('save-list.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(order) }); }

        function renderOrder() {
            const tbody = document.querySelector('#orderTable tbody'); tbody.innerHTML = ''; let tot = 0;
            order.forEach((r, i) => { tot += r.estTotal; tbody.insertRow().innerHTML = `<td>${r.item}</td><td>${r.qty}</td><td style="font-size:0.94em;">${r.vendor}</td><td style="text-align:right;">$${r.estTotal.toFixed(2)}</td><td><button onclick="order.splice(${i},1);save();renderOrder()" style="background:#dc2626;color:white;border:none;padding:9px 15px;border-radius:6px;">Delete</button></td>`; });
            document.getElementById('totalCost').textContent = `Total estimated: $${tot.toFixed(2)}`;
        }

        function esc(s) { return s.replace(/'/g, "\\'").replace(/"/g, "&quot;"); }
        function openTab(id) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="openTab('${id}')"]`).classList.add('active');
            document.getElementById(id).classList.add('active');
            if (id === 'all') document.getElementById('search')?.focus();
        }
        document.getElementById('search')?.addEventListener('input', renderAll);
    </script>
</body>
</html>